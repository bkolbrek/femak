      SUBROUTINE KAGVEL(VI100KM,VI100T,VI100Q,VI100R,VI100A,
     1	  VI100V,VI100DM1,VI100DM2,MODNR,NODNR,VFREQ,VPREE,VDIMP,KLOCE,
     2	  VCORE,VPRNE,KLD,KNE,VSRC)
C**********************************************************************C
C     KAGVEL.FOR						       C
C     Tonni F. Johansen 					       C
C     Kompaniet Numerisk Lyd					       C
C     17/12/92							       C
C								       C
C**********************************************************************C
C     To calculate normal velocity in hole in an infinite baffle.      C
C     As described by Kagawa et.al. J.S.&V. vol.69		       C
C     1980 p.207-228.  Assemble into global matrix in this routine.    C
C**********************************************************************C
      EXTERNAL BESSJ0
      DOUBLE PRECISION BESSJ0

      INTEGER MODNR,NODNR
      COMPLEX*16 VI100KM(MODNR),VI100T(MODNR,MODNR)
      COMPLEX*16 VI100Q(NODNR,MODNR),VI100R(MODNR),VI100A(MODNR)
      COMPLEX*16 VI100V(NODNR)
      COMPLEX*16 VI100DM1(NODNR,NODNR),VI100DM2(NODNR,NODNR)
      COMPLEX*16 VSRC(1)
      INTEGER KLD(1),KNE(1),KLOCE(1)
      REAL*8 VFREQ(1),VPREE(1),VCORE(1),VDIMP(1),VPRNE(1)


c      INTEGER NDIM,NNT
c      COMMON/COOR/NDIM,NNT

c      INTEGER NGIMP,NGSRC,NFREQ,NSIMP,NSRC
c      COMMON/AKUS/NGIMP,NGSRC,NFREQ,NSIMP,NSRC

c      INTEGER IFL,IGIMP,IFREQ,IGSRC,IFL1,NI100NOD,NI100MOD,NI100FL
c      REAL*8 I100RAD
c      COMMON/IMPEL/IFL,IGIMP,IFREQ,IGSRC,IFL1,NI100NOD,NI100MOD,
c     1		   NI100FL,I100RAD

c      INTEGER IEL,ITPE,ITPE1,IGRE,IDLE,ICE,IPRNE,IPREE,INEL,IDEG,
c     &		  IPG,ICODE,IDLE0,INEL0,IPG0
c      COMMON/RGDT/IEL,ITPE,ITPE1,IGRE,IDLE,ICE,IPRNE,IPREE,INEL,IDEG,
c     &		  IPG,ICODE,IDLE0,INEL0,IPG0


c      INTEGER M,MR,MP,M1
c      COMMON/ES/M,MR,MP,M1,M2,M3

c      INTEGER LCORG,LDLNC,LNEQ,LDIMP,LPRNG,LPREG,LLD,LLOCE,LCORE,
c     1	     LNE,LPRNE,LPREE,LDLE,LKE,LFE,LKGS,LKGD,LKGI,LFG,LRES,LDLG,
c     2	     LME,LDLE0,LDLG0,LFG0,LMGS,LMGD,LMGI,LIGS,LIGD,LIGI,LSRC,
c     3	     LIE,LSRE,LFREQ,LPRIG,LTYPRIG,LPRSG,LNDSRC,LTYPRSG,LI100A,
c     4	     LI100R,LI100T,LI100Q,LI100Y,LI100V,LI100KM,
c     5	     LI100E,LI100DM1,LI100DM2,LCOEXT
c      COMMON /LOC/ LCORG,LDLNC,LNEQ,LDIMP,LPRNG,LPREG,LLD,LLOCE,LCORE,
c     1	     LNE,LPRNE,LPREE,LDLE,LKE,LFE,LKGS,LKGD,LKGI,LFG,LRES,LDLG,
c     2	     LME,LDLE0,LDLG0,LFG0,LMGS,LMGD,LMGI,LIGS,LIGD,LIGI,LSRC,
c     3	     LIE,LSRE,LFREQ,LPRIG,LTYPRIG,LPRSG,LNDSRC,LTYPRSG,LI100A,
c     4	     LI100R,LI100T,LI100Q,LI100Y,LI100V,LI100KM,
c     5	     LI100E,LI100DM1,LI100DM2,LCOEXT


      include 'femak.cmn'    

      REAL*8 VA(1)
      COMMON VA

      INTEGER KD(20)
      COMPLEX*16 DET,ZERO
      INTEGER I,J
      REAL*8 K,Y,WM(10),X1,X2,X3

      REAL*8 GAMMA(10),J0GAMMA(10),PI
C...........Zero in first order bessel function Gamma
      DATA GAMMA/0.0,3.8317059702,7.0155866698,10.1734681351,
     1	      13.3236919363,16.4706300509,19.6158585105,
     2	      22.7600843806,25.9036720876,29.0468285349/
C............Value of zeroth order bessel function at gamma
      DATA J0GAMMA/1.0,-0.4027593957,0.3001157525,-0.2497048771,
     1	      0.21835994072,-0.1964653715,0.1800633753,-0.1671846005,
     2	      0.1567249863,-0.1480111100/
      DATA PI/3.141592654/,ZERO/(0.D0,0.D0)/


      W=2*PI*VFREQ(IFREQ)
      K=W/VPREE(2)

C..........ZERO VI100R, AND VI100A
      DO I=1,MODNR
	VI100R(I)=ZERO
	VI100A(I)=ZERO
      ENDDO

C.........Get elementinformation.
      ITPE=0
      REWIND(M6)
      DO WHILE (ITPE.NE.100)
          CALL RDCIMP(M6,KLOCE,VCORE,VPRNE,VPREE,KNE,IGIMP)
      END DO



C...........Assemble matrix E
      DO I=1,NI100MOD
	DO J=1,NI100MOD
	  IF (J.NE.I) THEN
	    VI100DM1(J,I)=VI100T(J,I)
	  ELSE
	    VI100DM1(J,I)=VI100T(J,I)+DCMPLX(1.,0.)
	  ENDIF
	ENDDO
      ENDDO


      CALL INVERSC(VI100DM1,NI100MOD,NI100NOD,KD,DET)


C...........VI100DM2()=INV(T+I)*Q'
      CALL MULTABC(VI100DM1,NI100MOD,NI100MOD,NI100NOD,NI100NOD,VI100Q,
     1		   NI100NOD,NI100MOD,NI100NOD,NI100MOD,VI100DM2,
     2		   NI100NOD,NI100NOD,2)

C.........VI100R()=1/(RO*W)*INV(T+I)*Q'*PB
      DO I=1,MODNR
	DO J=1,NODNR
	  VI100R(I)=VI100R(I)+VI100DM2(I,J)*VSRC(KNE(J))
	ENDDO
      ENDDO

      DO I=1,MODNR
	VI100R(I)=DCMPLX(0.,-1./(VPREE(1)*W))*VI100R(I)
      ENDDO

C.........VI100A()=T*R
      DO I=1,MODNR
	DO J=1,MODNR
	  VI100A(I)=VI100A(I)+VI100T(I,J)*VI100R(J)
	ENDDO
      ENDDO

C.........Write the modal coeffisients
      IF (M.GE.1) THEN
	WRITE(MP,1990)
1990	FORMAT(/,'MODAL COEFFISIENTS FOR ELEMENT TYPE 100',/
     1	       7X,'MODNR',22X,'A',30X,'R')

	DO I=1,MODNR
	  WRITE(MP,2000)I,VI100A(I),VI100R(I)
	END DO
2000	FORMAT(5X,I5,2(5X,'(',2E12.5,')'))
      ENDIF

      DO I=1,NODNR
	VI100V(I)=ZERO
      ENDDO

      DO I=1,NODNR
C.............Get eigenfunction at node no. I
	Y=VCORE(2*I)
	DO J=1,MODNR
	  WM(J)=BESSJ0(GAMMA(J)/I100RAD*Y)/SQRT(PI)/I100RAD/J0GAMMA(J)
	ENDDO

	DO J=1,MODNR
	  VI100V(I)=VI100V(I)+DCMPLX(0.,1.0)*VI100KM(J)*
     1				      (VI100A(J)-VI100R(J))*WM(J)
	ENDDO
      ENDDO


C.........Write the nodal velocities
	WRITE(MP,2090)
2090	FORMAT(/,'NODAL VELOCITIES FOR ELEMENT TYPE 100',/
     1	       3X,'NODNR',40X,'V')

	X3=0.0
	DO I=1,INEL
	  X1=VCORE(2*I-1)
	  X2=VCORE(2*I)
	  WRITE(MP,2100)KNE(I),X1,X2,X3,VI100V(I)
2100	  FORMAT(1X,I5,3E12.5,5X,'(',2E12.5,')')
      ENDDO

C........Calculate pressure in external nodes
      CALL EXTFLD100(VI100V,VFREQ,VPREE,VDIMP,KLOCE,VCORE,VPRNE,KLD,KNE,
     1		     VA(LCOEXT))


      RETURN
      END 
